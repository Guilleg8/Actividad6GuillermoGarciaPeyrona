version: '3.8'

services:

  # Jaeger
  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
      - "4317:4317"
    networks:
      - wakanda-net

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - wakanda-net

  # Grafana
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    networks:
      - wakanda-net
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=wakanda

  # 1. Service Registry
  service_registry:
    build:
      context: .
      dockerfile: services/service_registry/Dockerfile
    container_name: service_registry
    ports:
      - "8000:8000"
    environment:
      - JAEGER_HOST=jaeger
    networks:
      - wakanda-net

  # 2. Gestión Tráfico
  gestion_trafico:
    build:
      context: .
      dockerfile: services/gestion_trafico/Dockerfile
    container_name: gestion_trafico
    environment:
      - PORT=8001
      - REGISTRY_URL=http://service_registry:8000/register
      - JAEGER_HOST=jaeger
    networks:
      - wakanda-net
    depends_on:
      - service_registry

# 6. API Gateway
  gateway_api:
    build:
      context: .
      dockerfile: services/gateway_api/Dockerfile
    container_name: gateway_api
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - REGISTRY_URL=http://service_registry:8000
      - JAEGER_HOST=jaeger
    networks:
      - wakanda-net
    depends_on:
      - service_registry
      - gestion_trafico
      - gestion_energia

# 4. Gestión Energía
  gestion_energia:
    build:
      context: .
      dockerfile: services/gestion_energia/Dockerfile
    container_name: gestion_energia
    environment:
      - PORT=8002
      - REGISTRY_URL=http://service_registry:8000/register
      - JAEGER_HOST=jaeger
    networks:
      - wakanda-net
    depends_on:
      - service_registry

  # 5. Gestión Agua
  gestion_agua:
    build:
      context: .
      dockerfile: services/gestion_agua/Dockerfile
    container_name: gestion_agua
    environment:
      - PORT=8003
      - REGISTRY_URL=http://service_registry:8000/register
      - JAEGER_HOST=jaeger
    networks:
      - wakanda-net
    depends_on:
      - service_registry

  # 6. Gestión Residuos
  gestion_residuos:
    build:
      context: .
      dockerfile: services/gestion_residuos/Dockerfile
    container_name: gestion_residuos
    environment:
      - PORT=8004
      - REGISTRY_URL=http://service_registry:8000/register
      - JAEGER_HOST=jaeger
    networks:
      - wakanda-net
    depends_on:
      - service_registry

  # 7. Seguridad
  seguridad_vigilancia:
    build:
      context: .
      dockerfile: services/seguridad_vigilancia/Dockerfile
    container_name: seguridad_vigilancia
    environment:
      - PORT=8005
      - REGISTRY_URL=http://service_registry:8000/register
      - JAEGER_HOST=jaeger
    networks:
      - wakanda-net
    depends_on:
      - service_registry

  dashboard:
      image: python:3.9-slim
      container_name: wakanda_dashboard
      working_dir: /app
      volumes:
        - ./dashboard:/app
      environment:
        - GATEWAY_URL=http://gateway_api:8080
      command: >
        sh -c "pip install streamlit requests && streamlit run dashboard.py --server.port=8501 --server.address=0.0.0.0"
      ports:
        - "8501:8501"
      networks:
        - wakanda-net
      depends_on:
        - gateway_api

networks:
  wakanda-net:
    driver: bridge